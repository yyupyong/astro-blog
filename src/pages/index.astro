---
import Layout from "../layouts/Layout.astro";
import Card from "../components/Card.astro";
import { getCollection } from "astro:content";

const posts = (await getCollection("blog"))
  .filter((post) => !post.data.draft)
  .sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime());

const selectedTag = Astro.url.searchParams.get("tag");

const tagCounts = posts.reduce((acc, post) => {
  for (const tag of post.data.tags) {
    acc.set(tag, (acc.get(tag) ?? 0) + 1);
  }
  return acc;
}, new Map<string, number>());

const allTags = [...tagCounts.keys()].sort((a, b) => a.localeCompare(b));

const filteredPosts = selectedTag
  ? posts.filter((post) => post.data.tags.includes(selectedTag))
  : posts;
---

<Layout title="yupyong' blog">
  <main class="mt-12 px-8">
    <div class="container mx-auto px-4 lg:px-28 xl:px-28">
      <div class="mt-8 text-center">
        <h1 class="text-blue-500 text-4xl md:text-5xl font-bold">Yupyong Kim</h1>
        <p class="text-gray-400 text-l md:text-3xl mt-4">
          Thoughts, Interests, and Daily Reflections
        </p>
      </div>
      <h2 class="text-white text-3xl font-semibold mb-8 text-left py-8">
        Latest Articles
      </h2>
      <div class="mb-6 flex flex-wrap gap-3">
        <a
          href="/"
          class={`rounded-full border px-4 py-2 text-sm transition ${
            selectedTag === null
              ? "border-blue-500 bg-blue-500 text-white"
              : "border-gray-600 text-gray-300 hover:border-blue-400 hover:text-white"
          }`}
        >
          All ({posts.length})
        </a>
        {
          allTags.map((tag) => (
            <a
              href={`/?tag=${encodeURIComponent(tag)}`}
              class={`rounded-full border px-4 py-2 text-sm transition ${
                selectedTag === tag
                  ? "border-blue-500 bg-blue-500 text-white"
                  : "border-gray-600 text-gray-300 hover:border-blue-400 hover:text-white"
              }`}
            >
              #{tag} ({tagCounts.get(tag) ?? 0})
            </a>
          ))
        }
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        {
          filteredPosts.map((post) => (
            <Card
              href={post.slug}
              title={post.data.title}
              url={post.data.eyecatch}
              createdAt={post.data.pubDate.toISOString()}
              tags={post.data.tags}
            />
          ))
        }
      </div>
    </div>
  </main>
</Layout>
